// ============================================
// GLOW UP AGENCE - SCHÉMA PRISMA V9
// V8 + Tracking Talentbook
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  ADMIN
  HEAD_OF
  HEAD_OF_INFLUENCE
  HEAD_OF_SALES
  TM
  CM
  TALENT
}

enum Departement {
  INFLUENCE
  SALES
  ADMIN
}

enum TypeContenu {
  STORY
  STORY_CONCOURS
  POST
  POST_CONCOURS
  POST_COMMUN
  REEL
  TIKTOK_VIDEO
  YOUTUBE_VIDEO
  YOUTUBE_SHORT
  EVENT
  SHOOTING
  AMBASSADEUR
}

enum Source {
  INBOUND
  OUTBOUND
}

enum StatutCollab {
  NEGO
  PERDU
  GAGNE
  EN_COURS
  PUBLIE
  FACTURE_RECUE
  PAYE
}

enum StatutNego {
  BROUILLON
  EN_ATTENTE
  EN_DISCUSSION
  VALIDEE
  REFUSEE
  ANNULEE
}

enum StatutProspection {
  NOUVEAU
  CONTACTE
  EN_DISCUSSION
  PROPOSITION
  GAGNE
  PERDU
  STAND_BY
}

enum StatutDocument {
  BROUILLON
  ENVOYE
  VALIDE
  REFUSE
  PAYE
  ANNULE
}

enum StatutGift {
  BROUILLON
  EN_ATTENTE
  EN_COURS
  ATTENTE_MARQUE
  ACCEPTE
  REFUSE
  ENVOYE
  RECU
  ANNULE
}

enum TypeDocument {
  DEVIS
  BON_DE_COMMANDE
  FACTURE
  AVOIR
}

enum TypeTVA {
  FRANCE
  EU_INTRACOM
  EU_SANS_TVA
  HORS_EU
}

enum StatutCycle {
  A_VENIR
  EN_COURS
  PUBLIE
  FACTURE
  PAYE
}

enum TypeNotification {
  NOUVEAU_TALENT
  NOUVELLE_MARQUE
  BILAN_RETARD
  COLLAB_PUBLIE
  FACTURE_RECUE
  FACTURE_VALIDEE
  FACTURE_RELANCE
  COLLAB_GAGNEE
  PAIEMENT_RECU
  GENERAL
}

// ============================================
// USERS
// ============================================

model User {
  id            String       @id @default(cuid())
  email         String       @unique
  password      String
  prenom        String
  nom           String
  role          Role
  departement   Departement?
  telephone     String?
  actif         Boolean      @default(true)
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  talent        Talent?      @relation("UserTalent")
  talentsGeres  Talent[]     @relation("ManagerTalents")
  
  negociations      Negociation[]   @relation("TMNegociations")
  negosValidees     Negociation[]   @relation("ValidateurNegociations")
  negoCommentaires  NegoCommentaire[]
  
  prospections      Prospection[]
  documentsCreated  Document[]      @relation("DocumentCreateur")
  
  demandesGiftCreees    DemandeGift[]           @relation("TMDemandeGift")
  demandesGiftGerees    DemandeGift[]           @relation("AMDemandeGift")
  commentairesGift      CommentaireGift[]
  
  collabsGerees         Collaboration[]         @relation("AccountManagerCollabs")
  
  @@map("users")
}

// ============================================
// TALENTS
// ============================================

model Talent {
  id            String    @id @default(cuid())
  
  userId        String?   @unique
  user          User?     @relation("UserTalent", fields: [userId], references: [id])
  
  managerId     String
  manager       User      @relation("ManagerTalents", fields: [managerId], references: [id])
  
  // Infos personnelles
  prenom        String
  nom           String
  email         String
  telephone     String?
  dateNaissance DateTime?
  
  bio           String?   @db.Text
  presentation  String?   @db.Text
  presentationEn String?  @db.Text
  
  // Adresse complète
  adresse       String?
  codePostal    String?
  ville         String?
  pays          String?   @default("France")
  
  photo         String?
  
  // Réseaux sociaux
  instagram     String?
  tiktok        String?
  youtube       String?
  
  niches        String[]
  selectedClients String[]
  
  // Commissions
  commissionInbound   Decimal  @default(20)
  commissionOutbound  Decimal  @default(30)
  
  // Infos facturation (pour le portail talent)
  siret             String?
  iban              String?
  bic               String?
  titulaireCompte   String?
  
  dateArrivee   DateTime  @default(now())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  stats         TalentStats?
  tarifs        TalentTarifs?
  collaborations Collaboration[]
  negociations  Negociation[]
  talentbookEvents TalentbookEvent[]
  demandesGift  DemandeGift[]
  presskitTalents PressKitTalent[]
  
  @@map("talents")
}

// ============================================
// STATS TALENT
// ============================================

model TalentStats {
  id            String    @id @default(cuid())
  
  talentId      String    @unique
  talent        Talent    @relation(fields: [talentId], references: [id], onDelete: Cascade)
  
  igFollowers           Int?
  igFollowersEvol       Decimal?
  igEngagement          Decimal?
  igEngagementEvol      Decimal?
  igGenreFemme          Decimal?
  igGenreHomme          Decimal?
  igAge13_17            Decimal?
  igAge18_24            Decimal?
  igAge25_34            Decimal?
  igAge35_44            Decimal?
  igAge45Plus           Decimal?
  igLocFrance           Decimal?
  igLocAutre            String?
  
  ttFollowers           Int?
  ttFollowersEvol       Decimal?
  ttEngagement          Decimal?
  ttEngagementEvol      Decimal?
  ttGenreFemme          Decimal?
  ttGenreHomme          Decimal?
  ttAge13_17            Decimal?
  ttAge18_24            Decimal?
  ttAge25_34            Decimal?
  ttAge35_44            Decimal?
  ttAge45Plus           Decimal?
  ttLocFrance           Decimal?
  ttLocAutre            String?
  
  ytAbonnes             Int?
  ytAbonnesEvol         Decimal?
  
  lastUpdate    DateTime  @default(now())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("talent_stats")
}

// ============================================
// TARIFS TALENT
// ============================================

model TalentTarifs {
  id            String    @id @default(cuid())
  
  talentId      String    @unique
  talent        Talent    @relation(fields: [talentId], references: [id], onDelete: Cascade)
  
  tarifStory          Decimal?
  tarifStoryConcours  Decimal?
  tarifPost           Decimal?
  tarifPostConcours   Decimal?
  tarifPostCommun     Decimal?
  tarifReel           Decimal?
  tarifTiktokVideo    Decimal?
  tarifYoutubeVideo   Decimal?
  tarifYoutubeShort   Decimal?
  tarifEvent          Decimal?
  tarifShooting       Decimal?
  tarifAmbassadeur    Decimal?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("talent_tarifs")
}

// ============================================
// MARQUES
// ============================================

model Marque {
  id            String    @id @default(cuid())
  
  nom           String
  secteur       String?
  siteWeb       String?
  notes         String?   @db.Text
  
  raisonSociale     String?
  formeJuridique    String?
  siret             String?
  numeroTVA         String?
  tvaIntracom       String?
  
  adresseRue        String?
  adresseComplement String?
  codePostal        String?
  ville             String?
  pays              String?   @default("France")
  
  delaiPaiement     Int?      @default(30)
  modePaiement      String?
  devise            String?   @default("EUR")
  
  premiereCollabAt  DateTime?
  sourceInitiale    Source?
  prospectePar      String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  contacts      MarqueContact[]
  collaborations Collaboration[]
  negociations  Negociation[]
  prospections  Prospection[]
  demandesGift  DemandeGift[]
  
  @@map("marques")
}

model MarqueContact {
  id            String    @id @default(cuid())
  
  marqueId      String
  marque        Marque    @relation(fields: [marqueId], references: [id], onDelete: Cascade)
  
  prenom        String?
  nom           String
  email         String?
  telephone     String?
  poste         String?
  principal     Boolean   @default(false)
  
  createdAt     DateTime  @default(now())
  
  @@map("marque_contacts")
}

// ============================================
// PROSPECTIONS
// ============================================

model Prospection {
  id            String    @id @default(cuid())
  
  reference     String    @unique
  
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  
  marqueId      String
  marque        Marque    @relation(fields: [marqueId], references: [id])
  
  statut        StatutProspection @default(NOUVEAU)
  
  notes         String?   @db.Text
  dateContact   DateTime?
  dateRelance   DateTime?
  
  montantEstime Decimal?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([userId])
  @@index([marqueId])
  @@index([statut])
  @@map("prospections")
}

// ============================================
// NÉGOCIATIONS
// ============================================

model Negociation {
  id            String    @id @default(cuid())
  
  reference     String    @unique
  
  tmId          String
  tm            User      @relation("TMNegociations", fields: [tmId], references: [id])
  
  talentId      String
  talent        Talent    @relation(fields: [talentId], references: [id])
  
  marqueId      String?
  marque        Marque?   @relation(fields: [marqueId], references: [id])
  nomMarqueSaisi String?  // Nom saisi en négo ; à la validation → find-or-create marque (évite doublons)
  
  contactMarque     String?
  emailContact      String?
  
  source        Source    @default(INBOUND)
  
  brief         String?   @db.Text
  
  livrables     NegoLivrable[]
  
  budgetMarque      Decimal?
  budgetSouhaite    Decimal?
  budgetFinal       Decimal?
  
  dateContact       DateTime  @default(now())
  dateDeadline      DateTime?
  
  statut            StatutNego  @default(BROUILLON)
  
  validePar         String?
  validateur        User?     @relation("ValidateurNegociations", fields: [validePar], references: [id])
  dateValidation    DateTime?
  raisonRefus       String?
  
  collaborationId   String?   @unique
  collaboration     Collaboration? @relation(fields: [collaborationId], references: [id])
  
  commentaires      NegoCommentaire[]
  
  // Tracking des modifications
  modifiedSinceReview  Boolean   @default(false)
  lastModifiedAt       DateTime  @default(now())
  reviewedAt           DateTime?
  dateSubmitted        DateTime?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([tmId])
  @@index([talentId])
  @@index([marqueId])
  @@index([statut])
  @@map("negociations")
}

// ============================================
// LIVRABLES NÉGOCIATION
// ============================================

model NegoLivrable {
  id              String   @id @default(cuid())
  
  negociationId   String
  negociation     Negociation @relation(fields: [negociationId], references: [id], onDelete: Cascade)
  
  typeContenu     String   // Texte libre pour plus de flexibilité
  quantite        Int       @default(1)
  prixDemande     Decimal?
  prixSouhaite    Decimal?
  prixFinal       Decimal?
  description     String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([negociationId])
  @@map("nego_livrables")
}

// ============================================
// COMMENTAIRES NÉGOCIATION
// ============================================

model NegoCommentaire {
  id              String   @id @default(cuid())
  
  negociationId   String
  negociation     Negociation @relation(fields: [negociationId], references: [id], onDelete: Cascade)
  
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  contenu         String   @db.Text
  
  createdAt       DateTime @default(now())
  
  @@index([negociationId])
  @@map("nego_commentaires")
}

// ============================================
// COLLABORATIONS
// ============================================

model Collaboration {
  id            String    @id @default(cuid())
  
  reference     String    @unique
  
  talentId      String
  talent        Talent    @relation(fields: [talentId], references: [id])
  
  marqueId      String
  marque        Marque    @relation(fields: [marqueId], references: [id])
  
  // Account Manager assigné pour le suivi (après deal HEAD_OF_SALES)
  accountManagerId  String?
  accountManager    User?   @relation("AccountManagerCollabs", fields: [accountManagerId], references: [id])
  dateAssignationAM DateTime?
  
  livrables     CollabLivrable[]
  
  source            Source    @default(INBOUND)
  description       String?   @db.Text
  
  montantBrut       Decimal   @default(0)
  commissionPercent Decimal   @default(20)
  commissionEuros   Decimal   @default(0)
  montantNet        Decimal   @default(0)
  
  statut            StatutCollab  @default(NEGO)
  raisonPerdu       String?
  
  lienPublication   String?
  datePublication   DateTime?
  
  factureTalentUrl      String?
  factureTalentRecueAt  DateTime?
  factureValidee        Boolean   @default(false)
  factureValideeAt      DateTime?
  
  paidAt            DateTime?
  
  isLongTerme       Boolean   @default(false)
  
  marqueNotifiee    Boolean   @default(false)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  negociation       Negociation?
  
  cycles            CollabCycle[]
  documents         Document[]
  
  @@index([talentId])
  @@index([marqueId])
  @@index([statut])
  @@index([accountManagerId])
  @@map("collaborations")
}

// ============================================
// LIVRABLES COLLABORATION
// ============================================

model CollabLivrable {
  id              String   @id @default(cuid())
  
  collaborationId String
  collaboration   Collaboration @relation(fields: [collaborationId], references: [id], onDelete: Cascade)
  
  typeContenu     String   // Texte libre pour plus de flexibilité
  quantite        Int       @default(1)
  prixUnitaire    Decimal
  description     String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([collaborationId])
  @@map("collab_livrables")
}

// ============================================
// CYCLES (collabs long terme)
// ============================================

model CollabCycle {
  id            String    @id @default(cuid())
  
  collaborationId String
  collaboration   Collaboration @relation(fields: [collaborationId], references: [id], onDelete: Cascade)
  
  numero        Int
  description   String?
  
  dateDebut     DateTime?
  dateFin       DateTime?
  
  montantBrut       Decimal
  commissionEuros   Decimal
  montantNet        Decimal
  
  statut        StatutCycle   @default(A_VENIR)
  
  lienPublication   String?
  datePublication   DateTime?
  
  factureTalentUrl      String?
  factureTalentRecueAt  DateTime?
  paidAt                DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([collaborationId])
  @@map("collab_cycles")
}

// ============================================
// DOCUMENTS (Devis, BDC, Factures, Avoirs)
// ============================================

model Document {
  id            String    @id @default(cuid())
  
  reference     String    @unique
  
  type          TypeDocument
  statut        StatutDocument  @default(BROUILLON)
  
  collaborationId String?
  collaboration   Collaboration? @relation(fields: [collaborationId], references: [id], onDelete: SetNull)
  
  titre         String?
  
  montantHT     Decimal   @db.Decimal(10, 2)
  tauxTVA       Decimal   @db.Decimal(5, 2) @default(20)
  montantTVA    Decimal   @db.Decimal(10, 2)
  montantTTC    Decimal   @db.Decimal(10, 2)
  
  typeTVA       TypeTVA   @default(FRANCE)
  mentionTVA    String?
  
  lignes        Json?
  
  dateDocument  DateTime  @default(now())
  dateEmission  DateTime  @default(now())
  dateEcheance  DateTime?
  datePaiement  DateTime?
  dateValidation DateTime?
  
  factureRef    String?
  avoirRef      String?
  
  poClient      String?
  
  modePaiement  String?   @default("Virement")
  referencePaiement String?
  
  pdfBase64     String?   @db.Text
  fichierUrl    String?
  
  notes         String?   @db.Text
  
  createdById   String?
  createdBy     User?     @relation("DocumentCreateur", fields: [createdById], references: [id])
  
  // Relation transactions Qonto
  transactionsQonto TransactionQonto[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([collaborationId])
  @@index([type, statut])
  @@index([dateEcheance])
  @@index([reference])
  @@index([createdById])
  @@map("documents")
}

// ============================================
// COMPTEURS
// ============================================

model Compteur {
  id            String    @id @default(cuid())
  
  code          String?
  type          String
  annee         Int
  dernierNumero Int       @default(0)
  
  @@unique([type, annee])
  @@index([code])
  @@map("compteurs")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id            String           @id @default(cuid())
  
  userId        String
  
  type          TypeNotification @default(GENERAL)
  
  titre         String
  message       String
  lien          String?
  lu            Boolean          @default(false)
  luAt          DateTime?
  
  marqueId      String?
  talentId      String?
  collabId      String?
  
  createdAt     DateTime         @default(now())
  
  @@index([userId])
  @@index([userId, lu])
  @@index([type])
  @@map("notifications")
}

// ============================================
// PARAMÈTRES AGENCE
// ============================================

model AgenceSettings {
  id            String    @id @default(cuid())
  
  nom               String    @default("Glow Up Agence")
  logo              String?
  
  raisonSociale     String?
  formeJuridique    String?
  capitalSocial     String?
  siret             String?
  numeroTVA         String?
  rcs               String?
  
  adresseRue        String?
  adresseComplement String?
  codePostal        String?
  ville             String?
  pays              String?   @default("France")
  
  telephone         String?
  email             String?
  siteWeb           String?
  
  banque            String?
  iban              String?
  bic               String?
  
  mentionsDevis     String?   @db.Text
  mentionsFacture   String?   @db.Text
  conditionsPaiement String?  @db.Text
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("agence_settings")
}

// ============================================
// TALENTBOOK TRACKING
// ============================================

model TalentbookEvent {
  id        String   @id @default(cuid())
  
  type      String   // "page_view", "talent_click", "pdf_download", "favorite_add"
  
  talentId  String?
  talent    Talent?  @relation(fields: [talentId], references: [id], onDelete: Cascade)
  
  visitorId String   // ID anonyme du visiteur (stocké en localStorage)
  metadata  Json?    // Données supplémentaires (nombre de talents dans le PDF, etc.)
  
  createdAt DateTime @default(now())

  @@index([type])
  @@index([talentId])
  @@index([createdAt])
  @@map("talentbook_events")
}

// ============================================
// TRANSACTIONS QONTO (RÉCONCILIATION BANCAIRE)
// ============================================

model TransactionQonto {
  id                String    @id @default(cuid())
  qontoId           String    @unique // ID unique de la transaction Qonto
  
  // Informations transaction
  montant           Decimal   @db.Decimal(10, 2)
  devise            String    @default("EUR")
  libelle           String?   // Libellé du virement
  reference         String?   // Référence bancaire
  dateTransaction   DateTime  // Date du virement
  
  // Émetteur
  emetteur          String?   // Nom de l'émetteur
  emetteurIban      String?   // IBAN de l'émetteur
  
  // Statut
  statut            String    @default("PENDING") // PENDING, SETTLED, DECLINED
  
  // Association avec facture
  associe           Boolean   @default(false)
  documentId        String?
  document          Document? @relation(fields: [documentId], references: [id], onDelete: SetNull)
  
  // Métadonnées brutes Qonto
  metadata          Json?
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([documentId])
  @@index([associe])
  @@index([dateTransaction])
  @@index([statut])
  @@map("transactions_qonto")
}

// ============================================
// DEMANDES DE GIFTS
// ============================================

model DemandeGift {
  id                String        @id @default(cuid())
  reference         String        @unique // Format : GIFT-2026-0001
  
  // Relations
  talentId          String
  talent            Talent        @relation(fields: [talentId], references: [id], onDelete: Cascade)
  
  tmId              String
  tm                User          @relation("TMDemandeGift", fields: [tmId], references: [id])
  
  accountManagerId  String?
  accountManager    User?         @relation("AMDemandeGift", fields: [accountManagerId], references: [id])
  
  marqueId          String?
  marque            Marque?       @relation(fields: [marqueId], references: [id])
  
  // Détails de la demande
  statut            StatutGift    @default(BROUILLON)
  priorite          String        @default("NORMALE") // BASSE, NORMALE, HAUTE, URGENTE
  
  typeGift          String        // PRODUIT, EXPERIENCE, SERVICE, AUTRE
  description       String        @db.Text
  justification     String?       @db.Text // Pourquoi ce gift est important
  valeurEstimee     Decimal?      @db.Decimal(10, 2)
  
  // Informations supplémentaires
  datesouhaitee     DateTime?     // Date souhaitée de réception
  adresseLivraison  String?       @db.Text
  notesInternes     String?       @db.Text
  
  // Suivi
  datePriseEnCharge DateTime?     // Quand l'AM a pris en charge
  dateContactMarque DateTime?     // Quand l'AM a contacté la marque
  dateReponseMarque DateTime?     // Quand la marque a répondu
  dateEnvoi         DateTime?     // Date d'envoi du gift
  dateReception     DateTime?     // Date de réception par le talent
  
  numeroSuivi       String?       // Numéro de suivi du colis
  
  // Timestamps
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Relations
  commentaires      CommentaireGift[]
  
  @@index([talentId])
  @@index([tmId])
  @@index([accountManagerId])
  @@index([marqueId])
  @@index([statut])
  @@index([priorite])
  @@index([createdAt])
  @@map("demandes_gift")
}

model CommentaireGift {
  id              String      @id @default(cuid())
  
  demandeGiftId   String
  demandeGift     DemandeGift @relation(fields: [demandeGiftId], references: [id], onDelete: Cascade)
  
  auteurId        String
  auteur          User        @relation(fields: [auteurId], references: [id])
  
  contenu         String      @db.Text
  interne         Boolean     @default(false) // Si true, visible uniquement par TM et AM
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([demandeGiftId])
  @@index([auteurId])
  @@index([createdAt])
  @@map("commentaires_gift")
}

// ============================================
// SYSTÈME PRESS KIT AUTOMATISÉ
// ============================================

model Brand {
  id              String           @id @default(cuid())
  name            String
  slug            String           @unique
  domain          String?
  niche           String
  hubspotId       String?          @unique
  description     String           @db.Text // OBLIGATOIRE : décrit précisément ce que vend la marque
  logo            String?          // URL logo récupéré via Brandfetch
  primaryColor    String?          // Couleur primaire de la marque (#hex)
  secondaryColor  String?          // Couleur secondaire de la marque (#hex)
  category        String?          // Catégorie : MODE, BEAUTÉ, SPORT, FOOD, TECH, LIFESTYLE, SANTÉ, FINANCE, AUTRE
  presskitTalents PressKitTalent[]
  pageViews       PageView[]
  batches         BatchBrand[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  @@index([slug])
  @@index([hubspotId])
  @@index([niche])
  @@map("brands")
}

model PressKitTalent {
  id          String   @id @default(cuid())
  brand       Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  brandId     String
  talent      Talent   @relation(fields: [talentId], references: [id], onDelete: Cascade)
  talentId    String
  pitch       String   @db.Text // Phrase de vente percutante
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([brandId, talentId])
  @@index([brandId])
  @@index([talentId])
  @@map("presskit_talents")
}

model CaseStudy {
  id          String   @id @default(cuid())
  title       String
  brandName   String
  niche       String
  description String   @db.Text
  impressions String?
  engagement  String?
  extraMetric String?
  extraLabel  String?
  imageUrl    String?  // Photo de la campagne
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([niche])
  @@map("case_studies")
}

model PageView {
  id                 String   @id @default(cuid())
  brand              Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  brandId            String
  hubspotContactId   String?
  sessionId          String   // ID unique de session
  durationSeconds    Int      @default(0)
  scrollDepthPercent Int      @default(0)
  talentsViewed      String[] // IDs des talents qui ont été vus
  talentDurations    Json?    // Durées par talent: { "talentId": durationSeconds }
  visitNumber        Int      @default(1)
  ctaClicked         Boolean  @default(false)
  talentbookClicked  Boolean  @default(false) // Clic sur le lien "Voir le Talent Book complet"
  userAgent          String?
  ipAddress          String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  @@index([brandId])
  @@index([sessionId])
  @@index([hubspotContactId])
  @@index([createdAt])
  @@map("page_views")
}

model Batch {
  id          String       @id @default(cuid())
  name        String
  status      String       @default("processing") // processing, completed, failed
  totalBrands Int
  completed   Int          @default(0)
  failed      Int          @default(0)
  brands      BatchBrand[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  @@index([status])
  @@index([createdAt])
  @@map("batches")
}

model BatchBrand {
  id                String   @id @default(cuid())
  batch             Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  batchId           String
  brand             Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  brandId           String
  status            String   @default("pending") // pending, generating, completed, failed
  error             String?  @db.Text
  talentIds         String[] @default([]) // Talents spécifiques pour cette marque (override du défaut si fourni)
  hubspotContactIds String[] @default([]) // IDs des contacts HubSpot associés (plusieurs contacts par marque)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([batchId, brandId])
  @@index([batchId])
  @@index([brandId])
  @@index([status])
  @@map("batch_brands")
}
